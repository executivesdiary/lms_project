{% extends 'lead_management/base_dashboard.html' %}

{% block title %}Edit Connection{% endblock %}

{% block content %}
<!-- âœ… Bootstrap 5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container py-4">
    <h2 class="mb-4 text-center fw-bold">Edit Connection: {{ connection.full_name }}</h2>

    <form method="POST" enctype="multipart/form-data" class="bg-white shadow p-4 rounded">
        {% csrf_token %}
        {% for field in form %}
            <div class="mb-3">
                <label class="form-label">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        {% endfor %}

        <div class="mb-3">
            <label class="form-label">Upload Chat Screenshot</label>
            <input type="file" id="chat-upload" accept="image/*" class="form-control">
            <div class="form-text">You can upload one screenshot at a time. It will be shown below instantly.</div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Save Changes</button>
    </form>

    <!-- âœ… Screenshot Gallery with Scroll Arrows -->
    <h4 class="mt-5 fw-semibold">Uploaded Chat Screenshots</h4>
    <div class="position-relative border rounded mt-3 p-2">
        <button id="scroll-left" class="btn btn-dark position-absolute start-0 top-50 translate-middle-y z-1">&lt;</button>
        <div id="gallery" class="d-flex overflow-auto gap-3 px-5 py-2">
            {% for screenshot in screenshots %}
                <img src="{{ screenshot.image.url }}" alt="screenshot" class="zoomable" style="height: 150px; border-radius: 8px; cursor: pointer;">
            {% endfor %}
        </div>
        <button id="scroll-right" class="btn btn-dark position-absolute end-0 top-50 translate-middle-y z-1">&gt;</button>
    </div>
</div>

<!-- âœ… Zoom Modal -->
<div id="zoom-viewer" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-90 d-flex justify-content-center align-items-center" style="z-index: 1050;">
    <img id="zoom-image" src="" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
</div>

<!-- âœ… JS: AJAX Upload + Scroll + Zoom -->
<script>
document.getElementById('chat-upload').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('screenshot', file); // ðŸ‘ˆ must match Django view
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'upload_chat_screenshot' connection.id %}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.url) {
            const img = document.createElement('img');
            img.src = data.url;
            img.className = "zoomable";
            img.style.height = "150px";
            img.style.borderRadius = "8px";
            img.style.cursor = "pointer";
            document.getElementById('gallery').appendChild(img);
        } else {
            alert("Upload failed.");
        }
    })
    .catch(() => alert("Upload error."));
});

// Scroll buttons
document.getElementById('scroll-left').onclick = () => document.getElementById('gallery').scrollBy({ left: -300, behavior: 'smooth' });
document.getElementById('scroll-right').onclick = () => document.getElementById('gallery').scrollBy({ left: 300, behavior: 'smooth' });

// Zoom popup
document.addEventListener('click', function (e) {
    if (e.target.classList.contains('zoomable')) {
        document.getElementById('zoom-image').src = e.target.src;
        document.getElementById('zoom-viewer').classList.remove('d-none');
    }
});
document.getElementById('zoom-viewer').addEventListener('click', () => {
    document.getElementById('zoom-viewer').classList.add('d-none');
});
</script>
{% endblock %}
